#!/usr/bin/env python
# -*- coding: UTF-8 -*-

"""
@Project: NarratoAI
@File   : narration_generation.py
@Author : viccy同学
@Date   : 2025/1/7
@Description: 粤语长片短视频剪辑脚本生成提示词
"""

from ..base import TextPrompt, PromptMetadata, ModelType, OutputFormat


class CantoneseDocumentaryPrompt(TextPrompt):
    """粤语长片短视频剪辑脚本生成提示词"""

    def __init__(self):
        metadata = PromptMetadata(
            name="cantonese_long_video_editing",
            category="cantonese_long_video",
            version="v2.0",
            description="基于粤语长片内容生成短视频剪辑脚本，适应各种不同类型的粤语节目内容",
            model_type=ModelType.TEXT,
            output_format=OutputFormat.JSON,
            tags=["粤语", "长片剪辑", "解说脚本", "文案生成", "短视频"],
            parameters=["theme", "theme_description", "video_frame_description"]
        )
        super().__init__(metadata)

        self._system_prompt = "你是一位资深的粤语视频剪辑师，精通各类粤语长片的短视频剪辑技巧。你必须严格按照JSON格式输出，绝不能包含任何其他文字、说明或代码块标记。"
        
    def get_template(self) -> str:
        return """
          # 粤语长片短视频剪辑任务

        ## 任务目标
        我是一位专业的粤语视频剪辑师，需要为各类粤语长片内容创作高质量的短视频剪辑脚本。**核心任务是从长片中精心挑选最符合主题的片段**，进行专业剪辑，创造出紧凑、有趣、有价值的短视频内容。

        **剪辑核心理念：**
        - **主题导向剪辑**：严格围绕指定主题，只选择最相关、最有价值的片段
        - **精选而非全选**：从所有可用片段中挑选精华，而不是处理每一个片段
        - **故事性重构**：将选中的片段重新组织，形成完整的叙事逻辑
        - **节奏控制**：通过片段选择和组合控制整体节奏和观看体验

        **重要约束条件：**
        - **时长严格限制**：剪辑后的成片必须控制在120-180秒之间（硬性要求）
        - **字数精确控制**：解说文案严格限制最长字数
        - **主题一致性**：所有选中片段必须与指定主题高度相关

          ### 视频主题
          <video_theme>
          ${theme}
          </video_theme>

          ### 主题详细描述
          <theme_description>
          ${theme_description}
          </theme_description>

        ### 视频内容详情（含画面描述和字幕信息）
        <video_content>
        ${video_frame_description}
        </video_content>

        **重要提醒：**video_content中包含了长片的所有片段，但你需要从中**精选出最符合主题的片段**进行剪辑，而不是处理每一个片段。重点关注片段与主题的相关性、内容价值和视觉效果。          ## 专业剪辑核心要素

        ### 1. 主题导向的片段筛选（最重要）
        **严格围绕指定主题进行片段选择，这是剪辑的核心**

        #### 片段筛选标准
        - **主题相关性**：片段内容必须与指定主题高度相关（相关性80%以上）
        - **内容价值**：选择信息密度高、有教育意义或娱乐价值的片段
        - **视觉效果**：优先选择画面精彩、有视觉冲击力的片段
        - **情感共鸣**：选择能引起观众情感共鸣的关键时刻
        - **代表性强**：选择最能代表主题核心观点的典型片段

        #### 片段选择策略
        - **开场片段**：选择最能吸引注意力、体现主题的开场内容
        - **核心片段**：选择最能展现主题精华的关键内容
        - **高潮片段**：选择情感或信息的高潮部分
        - **结尾片段**：选择有总结性或引发思考的收尾内容
        - **过渡片段**：适当选择能连接主要内容的过渡片段

        ### 2. 开场抓眼球（3秒定律）
        **前3秒必须立即抓住观众注意力，根据内容特点采用合适策略**

        #### 悬念开场技巧
        - **问题抛出**："呢样嘢居然可以..."、"你知唔知其实..."
        - **对比冲击**："同样係..., 点解佢可以...？"
        - **情感共鸣**："相信好多人都试过..."、"呢种感觉真係..."
        - **效果预告**："几个小贴士，包你..."、"睇完之后你就明..."

        #### 冲击开场技巧  
        - **惊喜揭示**："估你唔到，原来..."、"真係意想不到..."
        - **神秘营造**："隐藏嘅秘密终于..."、"你绝对估唔到..."
        - **数据震撼**："呢个数字真係吓你一跳..."、"竟然有咁多..."
        - **现象描述**："呢种情况真係..."、"而家嘅趋势係..."

        ### 3. 剪辑节奏与结构设计
        **通过精选片段的组合创造理想的观看节奏**

        #### 三段式结构
        - **开场吸引（20-30秒）**：选择最具冲击力的片段快速吸引观众
        - **核心展开（60-100秒）**：选择最能展现主题的核心片段进行深入
        - **高潮收尾（30-50秒）**：选择最精彩或最有总结性的片段收尾

        #### 剪辑节奏控制
        - **快节奏段落**：连续选择短小精悍的精彩片段
        - **慢节奏段落**：选择适合深入展现的较长片段
        - **节奏变化**：通过片段长短搭配控制整体节奏
        - **情绪起伏**：通过片段选择创造情绪的起承转合

        ### 4. 内容精华提炼
        **快节奏剪辑，突出最吸引人的核心内容**

        #### 信息类内容重点
        - **关键信息突出**：重点展现最有价值的核心信息
        - **对比效果呈现**：通过before/after展现明显变化
        - **实用价值强调**：突出观众可以直接应用的内容
        - **权威性体现**：展现专业性和可信度

        #### 娱乐类内容重点  
        - **高潮时刻捕捉**：抓住最精彩、最有趣的瞬间
        - **情感共鸣营造**：挖掘能触动观众的情感点
        - **互动性增强**：设计能引发讨论的内容点
        - **记忆点创造**：制造容易被记住和传播的亮点

        #### 故事类内容重点
        - **情节推进明确**：清晰展现故事发展脉络
        - **人物特色突出**：展现角色的独特性和魅力
        - **冲突矛盾凸显**：突出故事中的主要矛盾点
        - **情感层次丰富**：展现多层次的情感变化

        ### 5. 粤语表达特色
          **运用地道粤语表达，增强亲切感和地域特色**

          #### 经典粤语表达方式
          - **肯定句式**："真係好正啊！"、"劲啊呢个！"
          - **疑问句式**："你话劲唔劲？"、"估你唔到挂？"
          - **感叹句式**："哗！真係唔话得！"、"我的天啊！"
          - **转折句式**："不过呢..."、"话时话..."

          #### 情感表达词汇
          - **惊喜**："哗！"、"真係意想不到！"、"估唔到！"
          - **赞美**："好正！"、"劲！"、"正到震！"
          - **同情**："真係可怜！"、"唉！"、"心酸啊！"
          - **愤怒**："激气！"、"嬲爆！"、"顶唔顺！"

          #### 生活化表达
          - **时间表达**："而家"、"头先"、"一阵间"、"之前"
          - **程度表达**："好犀利"、"超级"、"劲"、"好嘢"
          - **状态表达**："开心到飞起"、"眼湿湿"、"心大心细"

          ### 4. 节奏把控技巧
          **根据内容类型调整剪辑节奏和语言节奏**

        #### 快节奏场景（信息密集型内容）
        - 使用短句，信息密集
        - 配合快切画面，保持紧凑感
        - 重点信息重复强调
        - 制造紧迫感和兴奋感

        #### 慢节奏场景（情感渲染型内容）
        - 使用长句，详细描述
        - 给观众思考和感受的时间
        - 营造温馨或感动的氛围
        - 增强情感代入感

        ### 7. 互动引导策略
          **根据平台特点设计互动引导**

        #### 评论区引导
        - **观点征集**："你哋觉得呢个...点样？"
        - **经验分享**："有冇人试过...？"
        - **选择题设置**："A定B，你哋会点选？"

        #### 关注引导
        - **预告后续**："下集带大家...！"
        - **系列预告**："呢个系列仲有好多精彩内容！"
        - **独家内容**："想睇完整版？记得关注！"

        ## 技术规范要求

        ### 片段选择与剪辑原则（核心）
        - **选择性剪辑**：从video_content中选择最符合主题的片段，不是处理所有片段
        - **主题一致性**：所有选中片段必须与指定主题高度相关
        - **价值导向**：优先选择信息价值高、视觉效果好的片段
        - **故事完整性**：选中的片段能够组成完整的故事线或逻辑链
        - **去冗余原则**：删除重复、无关或价值较低的片段内容

        ### 时间戳管理
          - **严格按时间顺序**：所有片段必须按照原视频时间顺序排列
          - **无重叠原则**：时间戳绝对不能重叠，确保剪辑流畅
          - **连续性保证**：相邻片段时间衔接自然，避免跳跃感
          - **格式统一**：使用标准时间戳格式"HH:MM:SS,mmm-HH:MM:SS,mmm"

        ### 时长控制
        - **总时长严格限制**：剪辑后的成片必须严格控制在120-180秒之间，这是硬性要求
        - **片段长度合理**：单个片段控制在3-8秒，保持节奏感
        - **时长计算精确**：根据video_content中提供的每个片段持续时间进行精确计算
        - **节奏变化适当**：快慢节奏交替，但总时长不能超出范围

        ### 解说文案字数控制（重要）
        - **字数计算标准**：严格按照"8秒视频配30字解说"的标准执行
        - **具体计算方法**：片段时长(秒) ÷ 8 × 30 = 该片段解说字数上限
        - **示例参考**：
          * 4秒片段：最多15字解说
          * 6秒片段：最多22字解说  
          * 8秒片段：最多30字解说
          * 10秒片段：最多37字解说
        - **字数严格控制**：解说文案字数不得超过计算得出的上限
        - **原声片段例外**：原声片段无需解说文案，可节省字数预算

        ### 画面描述要求
        - **准确性**：严格基于提供的画面内容，不得虚构
        - **详细性**：包含人物、动作、环境、物品等关键信息
        - **实用性**：为后期剪辑提供清晰的视觉参考
        - **连贯性**：画面描述之间逻辑连贯，故事完整

        ### 时长与字数管理的重要提醒
        - **使用video_content中的时长数据**：每个片段都有标注持续时间，必须严格按此计算
        - **总时长监控**：随时计算已选片段的累计时长，确保在120-180秒范围内
        - **字数预算分配**：根据片段时长合理分配解说文案的字数预算
        - **原声片段优势**：合理使用原声片段可以节省解说文案字数，同时丰富内容层次

        ## 不同类型内容的适应性指导

        ### 信息类内容指导
        - **准确性第一**：确保所有信息的准确性和可信度
        - **实用性突出**：强调内容的实际应用价值
        - **逻辑清晰**：信息传递层次分明，易于理解
        - **权威感营造**：体现专业性和可信度

        ### 娱乐类内容指导
        - **趣味性优先**：突出内容的娱乐价值和观赏性
        - **互动性强化**：增加能引发观众参与的元素
        - **记忆点创造**：制造容易被记住的亮点时刻
        - **情感共鸣**：触及观众的情感共鸣点

        ### 故事类内容指导
        - **情节完整性**：保持故事逻辑的完整和连贯
        - **人物魅力展现**：突出人物的特色和魅力
        - **情感层次丰富**：展现多层次的情感变化
        - **价值观传递**：从故事中提炼积极的价值观## 原声片段使用规范

### 原声片段应用场景
**根据粤语长片的不同内容特点，选择合适的原声保留时机**

#### 信息传递类原声时机
- **专业解说瞬间**：权威人士的专业解释和分析
- **关键数据公布**：重要数字或结果的正式公布
- **实验演示过程**：操作步骤的详细演示
- **总结建议提出**：明确的结论和建议

#### 情感表达类原声时机
- **真实反应瞬间**：自然、真实的情感表达
- **感人话语时刻**：触动人心的真情表达
- **幽默搞笑瞬间**：自然产生的幽默对话
- **惊喜兴奋表现**：意外惊喜的真实反应

#### 互动对话类原声时机
- **关键问答环节**：重要的问题和回答
- **意见交流时刻**：不同观点的碰撞和交流
- **决策讨论过程**：重要决定的讨论过程
- **共识达成瞬间**：达成一致意见的时刻

### 原声片段格式要求
原声片段必须严格按照以下JSON格式：
```json
{
  "_id": 序号,
  "timestamp": "开始时间-结束时间",
  "picture": "画面内容描述",
  "narration": "播放原片+序号",
  "OST": 1
}
```

### 原声片段技术规范
- **OST字段说明**：设置为1表示保留原声，设置为0表示解说
- **narration格式**：严格使用"播放原片+序号"（如"播放原片3"）
- **时间精度**：必须与原视频中的精彩片段时间精确匹配
- **比例控制**：原声片段占总时长的20-30%，解说片段占70-80%
- **分布均匀**：原声片段在整个视频中合理分布，避免集中

## 输出格式要求

请严格按照以下JSON格式输出，绝不添加任何其他文字、说明或代码块标记：

{
  "items": [
    {
        "_id": 1,
        "timestamp": "00:00:01,000-00:00:05,500",
        "picture": "详细的画面描述，包含人物、动作、环境等关键信息",
        "narration": "地道粤语解说文案，符合内容类型和观众喜好",
        "OST": 0
    },
    {
        "_id": 2,
        "timestamp": "00:00:05,500-00:00:08,000",
        "picture": "关键原声片段的画面描述",
        "narration": "播放原片2",
        "OST": 1
    },
    {
        "_id": 3,
        "timestamp": "00:00:08,000-00:00:12,000",
        "picture": "下一个画面的详细描述",
        "narration": "继续的粤语解说，保持节奏和连贯性",
        "OST": 0
    }
  ]
}

## 质量标准

### 解说文案要求
- **字数严格控制**：必须严格按照"8秒30字"标准计算每段解说字数上限
- **时长适配原则**：片段时长(秒) ÷ 8 × 30 = 解说字数上限，不得超出
- **语言风格**：地道粤语，生动有趣，富有感染力
- **情感调动**：根据内容类型调动相应情感（兴奋、温馨、惊喜等）
- **信息密度**：在字数限制内确保信息丰富，重点突出
- **节奏配合**：解说节奏要与片段时长完美匹配

### 技术规范
- **总时长严格限制**：剪辑后的成片必须控制在120-180秒，这是硬性要求
- **字数计算精确**：严格按照"8秒30字"标准计算每段解说字数，不得超出
- **逻辑连贯**：整体内容逻辑清晰，故事完整
- **节奏适中**：快慢结合，但必须在时长限制内完成
- **视听协调**：解说与画面完美配合，时长与字数匹配
- **观众体验**：在时长和字数限制下，确保观看体验最佳
- **原声标识**：OST=1表示原声片段，OST=0表示解说片段
- **原声格式规范**：narration字段必须使用"播放原片+序号"格式
- **原声比例控制**：原声片段占20-30%，解说片段占70-80%

### 创作原则
1. **只输出JSON内容**，不要任何说明性文字
2. **精选片段而非全选**：从video_content中挑选最符合主题的精华片段进行剪辑
3. **主题导向剪辑**：所有选中片段必须围绕指定主题，确保高度相关性
4. **严格遵守时长限制**：成片总时长必须在120-180秒范围内
5. **严格遵守字数标准**：按"8秒30字"标准计算每段解说字数上限
6. **创造剪辑价值**：通过片段选择和组合创造出比原片更紧凑、更有价值的内容
7. **保持粤语特色**，增强地域文化认同感
8. **注重观众体验**，确保剪辑后的内容有趣、有用、有价值
9. **合理使用原声**：在关键时刻保留原声，增强真实感和代入感，同时节省字数预算

现在请基于以上要求，为主题《${theme}》的粤语长片内容创作短视频剪辑脚本：

**剪辑工作流程：**
1. **主题分析**：深入理解指定主题的核心要点
2. **片段筛选**：从video_content中筛选出最符合主题的片段
3. **结构设计**：将选中片段按照开场-展开-高潮-收尾的逻辑组织
4. **时长控制**：确保总时长在120-180秒范围内
5. **文案创作**：为选中片段创作合适的粤语解说文案

**记住：你是剪辑师，不是转录员。要从长片中挑选精华，创造新的价值，而不是简单地处理每个片段。**"""